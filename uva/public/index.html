<!DOCTYPE html>
<head>
  <title> Grappolo </title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <svg id="essevvuggi" float="right"></svg>
  <script src="//d3js.org/d3.v3.min.js"></script>
  <script>
/*
 Indice:
  -Interazione 
  -Variabili
  -Generazione 
  -Magia
  -Maturazione
  -Alterazione
  -Algoritmi
*/

//Interazione

  //eventi tastiera
onkeydown= function(e){
    var code = e.keyCode ? e.keyCode : e.which;
    switch(code){
    case 32: accresci(); break; //spazio
  }
}
  //lista per svg ["Funzione","onclick"] 
var funzioni= [
  ["RESET","inacerbizza()"],
  ["DFS","DFS()"],
  ["DFS_visit", "set_mode('DFS_visit')"],
  ["BFS_visit","set_mode('BFS_visit')"],
  ["Distanza","set_mode('seleziona_sorgente')"],
  //["Trasponi","trasponi()"],
  //["SCC","set_mode('SCC')"],
  ["Ispeziona","set_mode('info')"],
  ["Ingrandisci","accresci()"]
]
  //modalit√† di interazione
function set_mode(m){
  //reset
  circle.attr("onmouseover",null).attr("onmouseleave",null).attr("onclick",null)
  ids.attr("onmouseover",null).attr("onmouseleave",null).attr("onclick",null)
  //ifelseifelseifelseif...
  if(m == "DFS_visit")
  {
    ids.attr("onmouseover","DFS_visit(Number(this.innerHTML))")
    ids.attr("onmouseleave","inacerbizza()")
  }
  else if(m == "BFS_visit")
  {
    ids.attr("onclick","BFS_visit(Number(this.innerHTML))")
  }
  else if(m == "seleziona_sorgente")
  {
    ids.attr("onclick","BFS_visit(Number(this.innerHTML))")
    set_mode('seleziona_bersaglio');
  }
  else if(m == "seleziona_bersaglio")
  {
    ids.attr("onmouseover","showdistance(acini[Number(this.innerHTML)])")
    ids.attr("onmouseleave", "destroyinfo()")  
  }
  else if(m == "SCC()")
  {
    ids.attr("onclick","SCC(Number(this.innerHTML))")
  }
  else if(m == "info")
  {
    ids.attr("onmouseover","showinfo(acini[Number(this.innerHTML)])")
    ids.attr("onmouseleave", "destroyinfo()")  
  }
}
    
//Variabili globali

var enne= 50; //#vertici  |V|
var grappolo; //grafo   G(V,E)
var acini=[]; //vertici    V
var viticci=[]; //archi    E

//var piantato= false; 
var grosso= true;
//var pronto= true;

var width = innerWidth*.98,
    height = innerHeight*.97;

var svg = d3.select("body #essevvuggi")
    .attr("width", width)
    .attr("height", height);

var force; // d3.force per fisica
var path, circle, ids, functions; //classi svg

//Generazione grappolo

  //generazione matrice [n x n]
var grappolo= new Array(enne);
for(var i= 0; i<enne; i++){
  grappolo[i]= new Array(enne);
  for(var j= 0; j<enne; j++){
    if(i!==j && Math.random()*enne*enne*0.7<enne)
      grappolo[i][j]= 1;
    else
      grappolo[i][j]= 0;
  }
}

/* 
function pianta(){

  if(piantato==true){
    svg.selectAll("*").remove();
    acini=[];
    viticci=[];
    force=null;
  }

  piantato= true;
  grosso= true;
*/
  function crea_acini(){
    grappolo.forEach(function(acino,i,grappolo){
      acini.push(
        {
          "id":i,
          "uva":"acerba",
          "padre":null,
          "d":0,
          "f":0,
          "dist":Infinity
        }
      );
    });
  }

  crea_acini();

  function crea_viticci(){
    grappolo.forEach(function(acino,i,grappolo){
      acino.forEach(function(viticcio,j,acino){
        if(viticcio==1)
          viticci.push(
            {
              "source":acini[i],
              "target":acini[j],
              "tipo":null
            }
          );
      });
    });
  }

  crea_viticci();

  force = d3.layout.force()
    .nodes(d3.values(acini))
    .links(viticci)
    .size([width, height])
    .linkDistance(20)
    .charge(-200)
    .on("tick", tock)

  svg.append("defs").selectAll("marker")
      .data(["punta","punta_B","punta_T","punta_to","punta_F","punta_C"])
    .enter().append("marker")
      .attr("id", function(d) { return d; })
      .attr("viewBox", "0 -5 10 10")
      .attr("refX", 15)
      .attr("refY", -1.5)
      .attr("markerWidth", 5)
      .attr("markerHeight", 5)
      .attr("orient", "auto")
    .append("path")
      .attr("d", "M0,-5L10,0L0,5")

  path= create_path(); //nel tentativo di ricaricare parzialmente
  
  function create_path(){
    return svg.append("g").selectAll("path")
    .remove() //se funziona bene da mettere a tutti
    .data(viticci).enter()
      .append("path")
      .attr("class","viticcio")
      .attr("id",function(d){return"("+d.source.id+","+d.target.id+")"})
      .attr("marker-end","url(#punta)");
  }

  circle= svg.append("g").selectAll("circle")
    .data(acini).enter()
      .append("circle")
      .attr("r", 35)
      .attr("id",function(d){return d.id;})
      .attr("class","uva_acerba")
      .call(force.drag);

  ids= svg.append("g").selectAll("text")
    .data(acini).enter()
      .append("text")
      .attr("x",-11)
      .attr("y",8)
      .attr("font-family","Verdana")
      .attr("font-size",23)
      .attr("display","none")
      .text(function(d) { if(d.id<10)return '0'+d.id; return d.id })
      .call(force.drag);

  functions= svg.append("g").selectAll("text")
  .data(funzioni).enter()
    .append("text")
    .attr("x",0)
    .attr("y",function(e,i){return (i+1)*37})
    .attr("font-family","Verdana")
    .attr("font-size",35)
    .attr("onclick",function(e){return e[1]})
    .attr("class","testo")
    .html(function(e){return e[0]})

force.start();
set_mode();
//};

//Magia

function linkArc(d) {
  var dx = d.target.x - d.source.x,
      dy = d.target.y - d.source.y,
      dr = Math.sqrt(dx * dx + dy * dy);
  return "M" + d.source.x + "," + d.source.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
}

function transform(d) {
  return "translate(" + d.x + "," + d.y + ")";
}

function tock() {
  path.attr("d", linkArc);
  circle.attr("transform", transform);
  ids.attr("transform", transform);
}

function showinfo(acino) {
  svg.append("text")
    .attr("class","infobox")
    .attr("x",acino.x+15)
    .attr("y",acino.y+15)
    .attr("font-family","Verdana")
    .attr("font-size",10)   //tspans to linebreak
    .text("Parent: "+acino.padre+" Discovery time: "+acino.d+" Finishing time: "+acino.f+" Distance: "+acino.dist);
}

function showdistance(acino) {
   svg.append("text")
    .attr("class","infobox")
    .attr("x",acino.x+15)
    .attr("y",acino.y+15)
    .attr("font-family","Verdana")
    .attr("font-size",20)
    .text(" "+acino.dist);
}

function destroyinfo() {
  var todelete=document.getElementsByClassName('infobox');
  for(var i=0; i<todelete.length; i++)
    todelete[i].parentNode.removeChild(todelete[i])
}

//Maturazione del grappolo

var timer; //ricontrollare in ogni sua occorrenza
var quantoquanto;

function invecchia(i){
  var e = circle[0][i];
  T++; timer++;
  if(acini[e.id].uva == "acerba"){
    acini[e.id].uva = "matura";
    setTimeout(function(){
      d3.select(e).attr("class","uva_matura");
    },timer*quantoquanto);
  }
  else if(acini[e.id].uva=="matura"){
    acini[e.id].uva = "passa";
    setTimeout(function(){
      if(acini[e.id].padre==null)
        d3.select(e).attr("class","uva_sorgente");
      else
        d3.select(e).attr("class","uva_passa");
    },timer*quantoquanto);
  }
}

function inacerbizza(){
  T=0;
  acini.forEach(function(e){e.uva="acerba", e.padre=null, e.d=0, e.f=0, e.dist=Infinity})
  circle[0].forEach(function(e){acerba(e)})
  path[0].forEach(function(e){colora_viticcio(e)})
}

function acerba(e){
  d3.select(e).attr("class","uva_acerba");
}

function tipo_viticcio(i,j,tipo){
  path[0].some(function(e){
    if(e.id=="("+i+","+j+")")
    {
      setTimeout(function(){
        colora_viticcio(e,"to")
      },(timer)*quantoquanto+quantoquanto/2);
      setTimeout(function(){
        colora_viticcio(e,tipo)
      },(timer+1)*quantoquanto);
      return e;
    }
  });
}

function colora_viticcio(e,tipo){
  if(tipo) tipo= '_'+tipo;
  else tipo= '';
  d3.select(e).attr("class","viticcio"+tipo).attr("marker-end","url(#punta"+tipo+")")
}

//Alterazione del grappolo

function accresci(){
  if(grosso){
  circle.attr("r",15);
  ids.attr("display","inline");
  force.linkDistance(100).charge(-670).start()
  grosso= false;
  }
  else{
  circle.attr("r",35);
  ids.attr("display","none");
  force.linkDistance(20).charge(-200).start()
  grosso= true;
  }
}

function trasponi(){
  grappolo= grappolo[0].map(function(col, i) { 
    return grappolo.map(function(row) { 
    return row[i] 
    })
  });
  viticci=[];
  crea_viticci();
  create_path();
  force.start();
  /*pianta(); //da migliorare
  accresci();*/
}

/*function esegui(fun){
  if(pronto==true){
    pronto= false;
    fun();
    setTimeout(function(){pronto=true;return true;},timer*quantoquanto);
  }
}*/

//Algoritmi sui grappoli

var T=0;

function DFS()
{
  inacerbizza();
  for(var i=0; i<enne; i++)
    DFS_visit(i);
}

function DFS_visit(i){
  if(acini[i].uva!="acerba")
    return;
  invecchia(i);
  acini[i].d= T;
    for(var j=0; j<enne; j++)
      if(grappolo[i][j]!=0)
        {
          if(acini[j].uva=="acerba")
          {
            acini[j].padre= i;
            tipo_viticcio(i,j,"T");
            DFS_visit(j);
          }
          else if(acini[j].uva=="matura")
            tipo_viticcio(i,j,"B");
          else if(acini[j].d > acini[i].d)
            tipo_viticcio(i,j,"F");
          else
            tipo_viticcio(i,j,"C");
        }
  invecchia(i)
  acini[i].f= T;
}

function BFS_visit(s){
  var Q=[];
  inacerbizza();
  invecchia(s);
  acini[s].dist=0;
  Q.push(s);
  while(Q.length>0)
  {
    var u= Q.pop();
    for(var v= 0; v < enne; v++)
    {
      if(grappolo[u][v]!=0 && acini[v].uva=="acerba")
      {
        tipo_viticcio(u,v);
        invecchia(v);
        acini[v].dist= acini[u].dist + 1;
        acini[v].padre= u;
        Q.push(v);
      }
    }
    invecchia(u);
  }
}

function SCC(s){
  var cesto=[];
  var barattolo=[];
  for(var i= 0; i<enne; i++)
    if(acini[i].uva=="passa") cesto.push(i);
  DFS_visit(s)
  for(var i= 0; i<cesto.length; i++)
    if(acini[i].uva=="passa"){
      barattolo.push(i);
      seleziona(i);
    }
  alert(barattolo);
  return barattolo;
}

  </script>
</body>
